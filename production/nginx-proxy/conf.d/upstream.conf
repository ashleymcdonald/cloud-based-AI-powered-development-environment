# Dynamic upstream configuration for project services

# Map for connection upgrade
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# Map for project service discovery
map $project_name $project_vscode_upstream {
    default "${project_name}-claude-dev-env-service.claude-dev-${project_name}.svc.cluster.local:8443";
}

map $project_name $project_api_upstream {
    default "${project_name}-claude-dev-env-service.claude-dev-${project_name}.svc.cluster.local:3284";
}

map $project_name $project_dev_upstream {
    default "${project_name}-claude-dev-env-service.claude-dev-${project_name}.svc.cluster.local:3000";
}

# Geo-based rate limiting (optional)
geo $limit {
    default 1;
    10.0.0.0/8 0;
    172.16.0.0/12 0;
    192.168.0.0/16 0;
}

map $limit $limit_key {
    0 "";
    1 $binary_remote_addr;
}

# Rate limiting zones
limit_req_zone $limit_key zone=project_api:10m rate=30r/m;
limit_req_zone $limit_key zone=project_vscode:10m rate=10r/m;